---
title: "dm_abundance"
date: "20 January 2026"
output: html_document
author: "Elizabeth Daigle"
---
# Read in packages, functions, and directories
```{r}
source(paste0(here::here(), "/1-Config/config.R"))
```

# Read in sample metadata
```{r}
meta <- read_tsv(paste0(configDir, "/sampleReadList.txt"))
```

# Read in dsrAB gene counts
```{r}
# capsule data
capsule <- read_tsv(paste0(abundanceDir, "/Capsule/concat_dsrAB_col8score_Capsule_Abundances_RPKM_redo.txt"))
# stool data
stool <- read_tsv(paste0(abundanceDir, "/Stool/concat_dsrAB_col8score_Stool_Abundances_RPKM_redo.txt"))
# combine capsule and stool data
samples <- bind_rows(capsule, stool) %>%
  mutate(subject=as.numeric(str_extract(.$coassembly, "\\d+")))

# filter and remove duplicate genes
samples_unique_genes <- samples %>%
# Remove RPKMs of 0 (feature counts keeps genes even when nothing has mapped to them) 
  filter(RPKM>0) %>%
# make subject a factor
  mutate(subject = factor(subject)) %>%
# add capsule type (1,2,3,4, most proximal to most distal)
  left_join(meta %>% select(samplename, Type, Set), 
            by = c("sample" = "samplename")) %>%
# filter for unique genes in each sample
# want to keep gene domain with the highest score, if there is a tie return just the first hit encountered
  group_by(geneID, sample) %>%
  slice_max(Score, n = 1, with_ties = FALSE) %>%
  ungroup()
```
# Read in closest reference leaf info; only 2015 references
```{r}
closest_ref <- read_csv(paste0(dataDir, "closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule_no_2018.csv"))
```

# Add a column to samples that has the single_closest_ref
```{r}
samples_unique_genes_with_names <- samples_unique_genes %>% filter(geneLoc %in% closest_ref$hit_id) %>%
  left_join(closest_ref %>% select(hit_id, single_closest_ref),
            by = c("geneLoc" = "hit_id")) %>% 
  mutate(sample_type = ifelse(grepl("Stool", coassembly), "Stool", "Capsule"))

saveRDS(samples_unique_genes_with_names, file = paste0(dataDir, "/samples_unique_genes_with_names.rds"))
```




