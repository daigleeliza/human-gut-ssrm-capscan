---
title: "dm_abundance"
date: "20 January 2026"
output: html_document
author: "Elizabeth Daigle"
---
# Read in packages, functions, and directories
```{r}
source(paste0(here::here(), "/1-Config/config.R"))
```

# Read in sample metadata
```{r}
meta <- read_tsv(paste0(configDir, "/sampleReadList.txt"))
```

# Read in dsrAB gene counts
```{r}
# capsule data
capsule <- read_tsv(paste0(abundanceDir, "/Capsule/concat_dsrAB_col8score_Capsule_Abundances_RPKM.txt"))
# stool data
stool <- read_tsv(paste0(abundanceDir, "/Stool/concat_dsrAB_col8score_Stool_Abundances_RPKM.txt"))
# combine capsule and stool data
samples <- bind_rows(capsule, stool) %>%
  mutate(subject=as.numeric(str_extract(.$coassembly, "\\d+")))

# filter and remove duplicate genes
samples_unique_genes <- samples %>%
  mutate(RPKM = as.numeric(RPKM)) %>%
# Remove RPKMs of 0 (feature counts keeps genes even when nothing has mapped to them) 
  filter(RPKM>0) %>%
  mutate(subject = factor(subject)) %>%
# remove rest of file name from sample column (this can be fixed by rerunning concat rule and fixing column 2 str extraction)
  mutate(sample = sub("^(([^_]+_[^_]+)).*$", "\\1", sample)) %>%
# add capsule type
  left_join(meta %>% select(samplename, Type), 
            by = c("sample" = "samplename")) %>%
# filter for unique genes in each sample
# want to keep gene domain with the highest score, if there is a tie return just the first hit encountered
  group_by(geneID, sample) %>%
  slice_max(Score, n = 1, with_ties = FALSE) %>%
  ungroup()
```
# Read in closest reference leaf info
```{r}
closest_ref <- read_csv(paste0(dataDir, "closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule.csv"))
```

# Add a column to samples that has the single_closest_ref
```{r}
samples_unique_genes_with_names <- samples_unique_genes %>% filter(geneLoc %in% closest_ref$hit_id) %>%
  left_join(closest_ref %>% select(hit_id, single_closest_ref),
            by = c("geneLoc" = "hit_id")) %>% 
  mutate(sample_type = ifelse(grepl("Stool", coassembly), "Stool", "Capsule"))

saveRDS(samples_unique_genes_with_names, file = paste0(dataDir, "/samples_unique_genes_with_names.rds"))
```

## Why does samples_unique_genes have 739 rows but samples_unique_genes_with_names have 720 rows?
```{r}
rows_not_in_names <- samples_unique_genes %>%
  anti_join(samples_unique_genes_with_names)
## they are all this one Capsule_1.k141_35391_6/64-437
## my filtering above kept the 64-437, which was present in 19 samples from Capsule_1. The filtering pipeline used to make the closestRefInfo kept the 62-342 domain, which was present in 17 samples.
```


