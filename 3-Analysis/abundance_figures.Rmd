---
title: "abundance_figures"
date: "25 November 2025"
output: html_document
author: "Elizabeth Daigle"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Read in packages and functions
```{r}
source(paste0(here::here(), "/1-Config/config.R"))
```

```{r}
samples_unique_gene_casette <- readRDS(paste0(dataDir, "/samples_unique_genes_with_names.rds"))
```

# choose a representative subunit
```{r}
samples_unique_subunit_score <- samples_unique_gene_casette %>%
  group_by(contig, sample) %>%
  slice_max(Score, n = 1, with_ties = FALSE) %>%
  ungroup()


samples_unique_subunit_RPKM <- samples_unique_gene_casette %>%
  group_by(contig, sample) %>%
  slice_max(RPKM, n = 1, with_ties = FALSE) %>%
  ungroup()
```

## checking to see if there is a big difference between selecting subunits based on bit score or RPKM
```{r}
in_score_only <- anti_join(samples_unique_subunit_score, 
                           samples_unique_subunit_RPKM, 
                           by = c("geneID", "sample"))

in_rpkm_only <- anti_join(samples_unique_subunit_RPKM, 
                          samples_unique_subunit_score, 
                          by = c("geneID", "sample"))
```

```{r}
difference_between_higherBitandHigherRPKM <- in_rpkm_only$RPKM-in_score_only$RPKM
sum(difference_between_higherBitandHigherRPKM>2)
## there are 31 samples with a difference in RPKM that is greater than 2 if I select by higher bit score
## but all of the scores are still >200 if I select by higher RPKM. so I will go with that
```

## get summary statistics
```{r}
stats_per_subject <- samples_unique_subunit_RPKM %>%
  group_by(subject) %>%
  summarize(number_hits=n(), median_RPKM=round(median(RPKM),2), q_25_RPKM=round(quantile(RPKM, probs=0.25),2), q_75_RPKM=round(quantile(RPKM, probs=0.75),2), average_RPKM=round(mean(RPKM),2))

median(stats_per_subject$number_hits)
mean(stats_per_subject$number_hits)

stats_per_type <- samples_unique_subunit_RPKM %>%
  group_by(Type) %>%
  summarize(number_subjects=n_distinct(subject), number_hits=n(), median_RPKM=round(median(RPKM),2), q_25_RPKM=round(quantile(RPKM, probs=0.25),2), q_75_RPKM=round(quantile(RPKM, probs=0.75),2), average_RPKM=round(mean(RPKM),2))
  
stats_overall <- samples_unique_subunit_RPKM %>%
  summarize(number_hits=n(), median_hits_per_subject=(median(stats_per_subject$number_hits)), median_RPKM=round(median(RPKM),2), q_25_RPKM=round(quantile(RPKM, probs=0.25),2), q_75_RPKM=round(quantile(RPKM, probs=0.75),2), average_RPKM=round(mean(RPKM),2))
```




#here making new plots
Making viridis color palette for plots
```{r}
# Generate a viridis palette with 20 colors
viridis_palette <- viridis(20)
viridis_palette

boxplot_colors <- c(viridis_palette[6], viridis_palette[16])

jitter_colors <- c("#4477AA", "#59A075", "#AA3377", "#DDAA33", "#6F7042")

set_colors <- c("grey", "#4477AA", "#AA3377", "#4477AA", "#AA3377", "#4477AA", "#AA3377", "#4477AA", "#AA3377", "#4477AA", "#AA3377", "#4477AA", "#AA3377", "#6F7042")
```

# Plot the number of unique genes for each subject -> for comparing to asrABC
```{r}
plot_count_dsr <- samples_unique_subunit_RPKM %>%
# find number of unique genes for each sample
  group_by(subject, sample, Type) %>%
  summarize(n_contigs = n_distinct(contig), .groups="drop") %>%
  group_by(subject, Type) %>% 
  summarize(median_gene_set = median(n_contigs))

plot_count_dsr %>%
  ggplot(aes(x = Type, y = median_gene_set)) +
  geom_boxplot() + 
  geom_jitter(aes(color = Type),
              alpha = 0.7, 
              size = 3,
              position = position_jitter(width = 0.15, height = 0)) +
  scale_color_manual(values = jitter_colors) +
  labs(
    title = "Unique dsrAB genes per subject",
    x = "Sample type",
    y = "Median contig count across samples",
    color = "Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 24, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(size = 24),
    axis.title.y = element_text(size = 24),
    legend.text = element_text(size = 24),
    legend.title = element_text(size = 24),
    strip.placement = "outside",
    strip.background = element_blank(),
    plot.title = element_text(size = 28, hjust = 0.5),
    plot.subtitle = element_text(size = 24, hjust = 0.5))

plot_count_dsr %>%
  ggplot(aes(x = Type, y = n)) +
  geom_boxplot() + 
  geom_jitter(aes(color = Type),
              alpha = 0.7, 
              size = 3,
              position = position_jitter(width = 0.15, height = 0)) +
  scale_color_manual(values = jitter_colors) +
  facet_wrap(~ subject,
              #scales = "free_y",
              strip.position = "bottom",
              labeller = labeller(subject = function(x) paste("Subject", x))) +
  labs(
    title = "Unique dsrAB gene count by sample type across subjects",
    x = "Sample Type",
    y = "Gene Count",
    color = "Type"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(size = 24, angle = 45, hjust = 1),
    axis.text.y = element_text(size = 24),
    axis.title.x = element_text(size = 24),
    axis.title.y = element_text(size = 24),
    legend.text = element_text(size = 24),
    legend.title = element_text(size = 24),
    strip.placement = "outside",
    strip.background = element_blank(),
    plot.title = element_text(size = 28, hjust = 0.5),
    plot.subtitle = element_text(size = 24, hjust = 0.5))
```
# Change species labels
```{r}
species <- unique(samples_unique_genes_with_names$single_closest_ref)

species_labels <- c("Desulfitibacter_alkalitolerans__DfiAlka2" = "Desulfitibacter alkalitolerans",
                    "Desulfovibrio_piger__DslPige3" = "Desulfovibrio piger 3",
                    "Desulfovibrio_piger__DslPige4" = "Desulfovibrio piger 4",
                    "Bilophila_wadsworthia__BilWads6" = "Bilophila wadsworthia 6",
                    "uncultured_bacterium__EF645667" = "Desulfovibrio desulfuricans",
                    "Bilophila_sp._4_1_30__BilSpec3" = "Bilophila species 3",
                    "Gordonibacter_pamelaeae__GrdPame5" = "Gordonibacter pamelaeae",
                    "Moorella_thermoacetica_Y72_copy_2__MooTher5" = "Moorella thermoacetica",
                    "Anaerobic_bacterium_sk.prop8__Bv2Prop2" = "Anaerobic bacterium")

species_labels_combine_species <- c("Desulfitibacter_alkalitolerans__DfiAlka2" = "italic(Desulfitibacter~alkalitolerans)",
                    "Desulfovibrio_piger" = "italic(Desulfovibrio~piger)",
                    "Bilophila_species" = "italic(Bilophila)~species",
                    "uncultured_bacterium__EF645667" = "italic(Desulfovibrio~desulfuricans)",
                    "Gordonibacter_pamelaeae__GrdPame5" = "italic(Gordonibacter~pamelaeae)",
                    "Moorella_thermoacetica_Y72_copy_2__MooTher5" = "italic(Moorella~thermoacetica)",
                    "Anaerobic_bacterium_sk.prop8__Bv2Prop2" = "'Anaerobic bacterium'")
```

# plot RPKM for unique genes (each hit would be one subunit) in each sample to compare between species; facet by location and subject
```{r}
samples_unique_subunit_RPKM %>%
  ggplot(aes(x = single_closest_ref, y = log10(RPKM), fill = Type)) +
  geom_boxplot(color = "black",
               position = position_dodge(width = 0.8), size = 0.8) +
  geom_jitter(aes(color = Type),
            alpha = 0.9, size = 2,
            position = position_jitterdodge(
        jitter.width = 0.5,
        dodge.width = 0.8)) +
  scale_color_manual(values = jitter_colors) +
  #get rid of box fill
  scale_fill_manual(values = c("transparent", "transparent", "transparent", "transparent", "transparent"), guide = "none") +
  scale_x_discrete(labels = species_labels) + 
  guides(fill = "none") +
  facet_grid(subject ~ Type, scale = "free_y") +
  labs(
    title = "RPKM for unique dsrAB genes by species across subjects and sample locations",
    x = "Closest Reference",
    y = "log10(RPKM)",
    color = "Sample Location"
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size = 12, angle = 60, hjust = 1),
    plot.title = element_text(size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5)
  )
```
#  plot RPKM for unique genes (each hit would be one subunit) in each sample to compare between location; facet by species and subject
```{r}
samples_unique_subunit_RPKM %>%
  ggplot(aes(x = Type, y = log10(RPKM))) +
  geom_boxplot(color = "black",
               position = position_dodge(width = 0.8), size = 0.8) +
  geom_jitter(aes(color = Type),
            alpha = 0.9, size = 2,
            position = position_jitterdodge(
        jitter.width = 0.5,
        dodge.width = 0.8)) +
  scale_color_manual(values = jitter_colors) +
  #get rid of box fill
  scale_fill_manual(values = c("transparent", "transparent", "transparent", "transparent", "transparent"), guide = "none") +
  guides(fill = "none") +
  facet_grid(subject ~ single_closest_ref, 
             scale = "free_y",
             labeller = labeller(single_closest_ref = species_labels)) +
  labs(
    title = "RPKM for unique dsrAB genes by sample location across subjects and species",
    x = "Sample Location",
    y = "log10(RPKM)",
    color = "Sample Location"
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size = 12, angle = 60, hjust = 1),
    plot.title = element_text(size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5)
  )
ggsave("dsrAB_RPKM.png",
       width = 16, height = 14, units = "in",   # increase for larger output
       dpi = 600)
```
# plot RPKM for unique genes (each hit would be one subunit) in each sample to compare between location; facet by species and subject
# this plot combines the two D. piger and two B. wadsworthia species
```{r}
samples_unique_subunit_RPKM %>%
  #remove moorella because its distance from the queries is 7.5 (all others are less than 2.5)
  filter(single_closest_ref != "Moorella_thermoacetica_Y72_copy_2__MooTher5") %>%
  mutate(combine_species = case_when(
    single_closest_ref %in% c("Desulfovibrio_piger__DslPige3", "Desulfovibrio_piger__DslPige4") ~ "Desulfovibrio_piger",
    single_closest_ref %in% c("Bilophila_wadsworthia__BilWads6", "Bilophila_sp._4_1_30__BilSpec3") ~ "Bilophila_species",
    TRUE ~ single_closest_ref)) %>%
  mutate(combine_species = factor(combine_species, 
                                  levels = c("Desulfovibrio_piger", 
                                            "uncultured_bacterium__EF645667",
                                            "Bilophila_species",
                                            "Desulfitibacter_alkalitolerans__DfiAlka2",
                                            "Gordonibacter_pamelaeae__GrdPame5",
                                            "Anaerobic_bacterium_sk.prop8__Bv2Prop2"))) %>%
  mutate(combine_species = recode(combine_species, !!!species_labels_combine_species)) %>%
  ggplot(aes(x = Type, y = log10(RPKM))) +
  geom_boxplot(color = "black",
               position = position_dodge(width = 0.8), size = 0.8) +
  geom_jitter(aes(color = Type),
            alpha = 0.9, size = 1,
            position = position_jitterdodge(
        jitter.width = 0.5,
        dodge.width = 0.8)) +
  scale_color_manual(values = jitter_colors) +
  #get rid of box fill
  scale_fill_manual(values = c("transparent", "transparent", "transparent", "transparent", "transparent"), guide = "none") +
  guides(fill = "none") +
  facet_grid(subject ~ combine_species, 
             scale = "free_y",
             labeller = labeller(combine_species = label_parsed)) +
             #labeller = labeller(combine_species = species_labels_combine_species)) +
  labs(
    title = "RPKM for unique dsrAB genes by sample location across subjects and species",
    x = "Sample Location",
    y = "log10(RPKM)",
    color = "Sample Location"
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size = 12, angle = 60, hjust = 1),
    plot.title = element_text(size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5)
  )
ggsave("dsrAB_RPKM_combine_species.png",
       width = 16, height = 14, units = "in",   # increase for larger output
       dpi = 600)
```
# this takes the jitter box plot and adds coloring for the time of day for the capsule in which the hit was found
# also orders the subjects based on whether they have d. piger or d. alkalitolerans
```{r}
samples_unique_subunit_RPKM %>%
  #remove moorella because its distance from the queries is 7.5 (all others are less than 2.5)
  filter(single_closest_ref != "Moorella_thermoacetica_Y72_copy_2__MooTher5") %>%
  mutate(combine_species = case_when(
    single_closest_ref %in% c("Desulfovibrio_piger__DslPige3", "Desulfovibrio_piger__DslPige4") ~ "Desulfovibrio_piger",
    single_closest_ref %in% c("Bilophila_wadsworthia__BilWads6", "Bilophila_sp._4_1_30__BilSpec3") ~ "Bilophila_species",
    TRUE ~ single_closest_ref)) %>%
  mutate(combine_species = factor(combine_species, 
                                  levels = c("Desulfovibrio_piger", 
                                            "uncultured_bacterium__EF645667",
                                            "Bilophila_species",
                                            "Desulfitibacter_alkalitolerans__DfiAlka2",
                                            "Gordonibacter_pamelaeae__GrdPame5",
                                            "Anaerobic_bacterium_sk.prop8__Bv2Prop2"))) %>%
  mutate(combine_species = recode(combine_species, !!!species_labels_combine_species)) %>%
  ggplot(aes(x = Type, y = log10(RPKM))) +
  geom_boxplot(color = "black",
               position = position_dodge(width = 0.8), size = 0.8) +
  geom_jitter(aes(color = Set),
            alpha = 0.9, size = 1,
            position = position_jitterdodge(
        jitter.width = 0.5,
        dodge.width = 0.8)) +
  scale_color_manual(values = set_colors) +
  #get rid of box fill
  scale_fill_manual(values = c("transparent", "transparent", "transparent", "transparent", "transparent"), guide = "none") +
  guides(fill = "none") +
  facet_grid(subject ~ combine_species, 
             scale = "free_y",
             labeller = labeller(combine_species = label_parsed)) +
             #labeller = labeller(combine_species = species_labels_combine_species)) +
  labs(
    title = "RPKM for unique dsrAB genes by sample location across subjects and species",
    x = "Sample Location",
    y = "log10(RPKM)",
    color = "Sample Location"
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 10),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size = 12, angle = 60, hjust = 1),
    plot.title = element_text(size = 20, hjust = 0.5),
    plot.subtitle = element_text(size = 16, hjust = 0.5)
  )

```




# HEATMAPPING

##need to normalize and convert to log2 first
```{r}
# read in MOIs df and remove columns without names and extra variables
mois <- readRDS(paste0(data_dir, "/clean_data/moi_with_names.rds"))

intensity_df <- mois %>% 
  select(!contains("_pos") & !contains("_neg")) %>%
  select(-(sample:is_nutrition)) %>%
  column_to_rownames(., var = "Sample_ID")

# normalize
sample_intensity_sums <- rowSums(intensity_df)
intensity_norm <- (intensity_df/sample_intensity_sums)*100

# transform  
intensity_norm_log <- (log2(intensity_norm)) %>%
  as.matrix() %>% 
  t()
```

```{r}
# get info on child sex and abx
ps <- readRDS(paste0(data_dir, "ps_tipglom_midline_public.RDS"))
sex_abx <- sample_data(ps) %>% data.frame() %>% select(childid, sex, abx_times3mo) %>%
  filter(childid %in% mois$childid) %>%
  filter(str_detect(rownames(.), "M"))

# for annotations of nutrition group, sex, and abx; df with sample ID as row names
sample_ann <- mois %>% 
  select(childid, Sample_ID, is_nutrition) %>%
  left_join(., sex_abx, by = "childid") %>%
  column_to_rownames(., var = "Sample_ID") %>%
  mutate(`nutrition group` = is_nutrition) %>%
# add variable for whether or not child took antibiotics
  mutate(antibiotics = ifelse(abx_times3mo >= 1, TRUE, FALSE)) %>%
  select(-c(is_nutrition, childid, abx_times3mo))

# mapping annotations; shape for sex, color for nutrition and abx
  
sample_ann_heatmap = HeatmapAnnotation(`nutrition group` = as.character(sample_ann$`nutrition group`),
                                       col = list(`nutrition group` = setNames(c("#1b6ab0", "#ffd25b"), 
                                                                               c(TRUE, FALSE))),
                                       which = "column", 
                                       annotation_legend_param = list(`nutrition group` = 
                                                                     list(title_gp = 
                                                                            gpar(fontsize = 8),
                                                                          labels_gp = 
                                                                            gpar(fontsize = 6),
                                                                          grid_height = unit(3, "mm"),
                                                                          grid_width = unit(3, "mm"))),
                                       show_legend = TRUE,
                                    show_annotation_name = FALSE)
# move nutrition group to anno_simple() and add pch to anno_simple to see which samples are from female children    #pch = ifelse(sample_ann$sex == "Female", "^", NA))
# add abx
#antibiotics = anno_simple(as.character(sample_ann$antibiotics), col = c("TRUE" = "transparent", "FALSE" = "transparent"), pch = ifelse(sample_ann$antibiotics == "TRUE", "^", NA), which = "column")
```                                       

# Grouping metabolites for color annotation
```{r}
# Name groups 
# "Drugs" includes Anti-Arrhythmics, Aromatase Inhibitors + Cancer Drugs, Birth Control, Clotting or Anti-Clotting, Muscle Relaxants, and Parkinson's and Alzheimer's Drugs

# extract metabolite names and add group names
# for annotations, df with metabolites as row names
metabolites <- data.frame(name = colnames(intensity_df)) %>%
  mutate(group = group) %>%
  column_to_rownames(var = "name")


met_ann_heatmap = HeatmapAnnotation(`metabolite group` = metabolites$group,
                                    col = list(`metabolite group` = setNames(
                                        c("#9D8749", "#E9A571", "#4F988B", "#7ACD87", "#6F85CB", "#7CBFEB", "#C46686", "#F2FFFF"), 
                                        c("Antibacterial, Antifungal, + Antiparasitic", 
                                                        "Antihistamines",
                                                        "Bile Acids + Conjugates", 
                                                        "Crop + Manufacturing Additives",
                                                        "Fungal Metabolites", 
                                                        "Human Metabolites",
                                                        "Terpenes + Natural Products", 
                                                        "Drugs + Others"))),
                                    which = "row", 
                                    annotation_legend_param = list(`metabolite group` = 
                                                                     list(title_gp = 
                                                                            gpar(fontsize = 8),
                                                                          labels_gp = 
                                                                            gpar(fontsize = 6),
                                                                          grid_height = unit(3, "mm"),
                                                                          grid_width = unit(3, "mm"))),
                                    show_legend = TRUE,
                                    show_annotation_name = FALSE)
```



```{r}
png("met_heatmap.png", width = 8, height = 9.5, units = "in", res = 300)
hm <- ComplexHeatmap::pheatmap(intensity_norm_log,
                   main = "Normalized log2 metabolite intensities across samples",
                   color = viridis(50, begin = 0.1, end = 0.95),
                   breaks = NA,
                   cluster_rows = TRUE,
                   cluster_cols = TRUE,
                   clustering_distance_rows = "euclidean",
                   clustering_distance_cols = "euclidean",
                   clustering_method = 'ward.D',
                   show_colnames = F,
                   annotation_names_col = F,
                   fontsize = 10,
                   fontsize_row = 3,
                   top_annotation = sample_ann_heatmap,
                   right_annotation = met_ann_heatmap,
                   treeheight_col = 0,
                   treeheight_row = 0,
                   heatmap_legend_param = list(title = "Norm log2(intensity)"))

draw(hm, annotation_legend_side = "right", heatmap_legend_side = "right")

dev.off()
```

