---
title: "overall_ref_tree_hit_refs_highlighted"
output: html_document
date: "2024-04-17"
---

# packages and dfs to load
```{r}
library(ggplot2)
library(treeio)
library(ggtree)
library(dplyr)
library(ape)
library(phytools)
library(readr)
library(seqinr)
library(xlsx)
library(readxl)

rooted_result_tree_f = read.tree("/Users/rebeccachristensen/Desktop/Cremer_Lab_2022/main/workflow/out/raxmlOutputNovelFragInsert/RAxML_labelledTree_noBootstrap_rooted_wKarthikSeqs.newick")

closestRefInfo_allScoreThresholdHits_wKarthikSeqsAsRef <- read_csv("closestRefInfo_allScoreThresholdHits_wKarthikSeqsAsRef_wSingleClosestRef.csv")
tax_df <- read_csv("tax_df.csv")

tax_df_closest_hits <- read_excel("tax_df_closest_hits.xlsx", 
    col_types = c("skip", "text", "text", 
        "text", "text", "text", "text", "text", 
        "text", "text", "text", "text"))

ref_seqs <- read_csv("ref_seqs.csv")
karthik_seqs_in_tree <- read_csv("karthik_seqs_in_tree.csv")
all_seqs <- read_csv("all_seqs.csv")
hit_otus <- read_csv("hit_otus.csv", col_types = cols(...1 = col_skip()))

```

# tree prep - tip pruning + clade subsetting
```{r}
# prune tree to only include leaves that are either from mueller 2015 (subset for ) or are novel anatharaman 2018 seqs
reductive_tips <- subset(tax_df, grepl("Reductive", tax_1))$tip_label
long_edge_karthik_seqs_to_drop <- c("QUERY___rifoxyc1_full_scaffold_51380_dsrB", 
                                    "QUERY___rifixya3_full_scaffold_25079_dsrB", 
                                    "QUERY___rifoxyd2_full_scaffold_44429_dsrA", 
                                    "QUERY___DORA_ECA_850_dsrB", 
                                    "QUERY___RBG_13_OP3_44_8_RBG_13_scaffold_10190_dsrB", 
                                    "QUERY___mol-32-1605-051718_dsrB", 
                                    "QUERY___DORA_UNB_8638_dsrB", 
                                    "QUERY___Infant_1_KP_23_dsrB", 
                                    "QUERY___UC1CITii_18930_dsrB", 
                                    "QUERY___scnpilot_cont_500_p_scaffold_168_curated_dsrB", 
                                    "QUERY___UC1SER_17878_dsrB")

oxidative_taxa <- c("Betaproteobacteria", 
                    "Nitrospinae", 
                    "Nitrospirae_bacterium_RBG_19FT_COMBO_42_15_dsrA", 
                    "RIFOXYD12_FULL_Gammaproteobacteria_61_37", 
                    "Chlorobium")

# identifying Anantharamn sequences not within the clades identified in Mueller 2015

ref_tips <- append(subset(ref_seqs, tip_label %in% reductive_tips)$tip_label, subset(karthik_seqs_in_tree, grepl("Moorella", tip_label) == F & !(tip_label %in% long_edge_karthik_seqs_to_drop))$tip_label)

pruned_t <- drop.tip(rooted_result_tree_f, drop_tips)
reductive_mrca <- MRCA(pruned_t, reductive_tips)
  
reductive_t <- extract.clade(pruned_t, reductive_mrca)

red_karthik_seqs <- subset(karthik_seqs_in_tree, tip_label %in% reductive_t$tip.label)$tip_label
red_karthik_seqs <- subset(karthik_seqs_in_tree, tip_label %in% reductive_t$tip.label)$tip_label

not_karthik_seqs <- setdiff(all_seqs$tip_label, red_karthik_seqs)
karthik_t <- drop.tip(rooted_result_tree_f, not_karthik_seqs)

# find MRCA of Anantharaman seqs in Mueller clades to drop tips in these nodes

deltaprot_t <- extract.clade(reductive_t, deltaprot_mrca)
deltaprot_karthik_tips <- deltaprot_t$tip.label[grepl("QUERY", deltaprot_t$tip.label)]
deltaprot_karthik_mrca <- MRCA(karthik_t, deltaprot_karthik_tips)

nitrospirae_t <- extract.clade(reductive_t, nitrospirae_mrca)
nitrospirae_karthik_tips <- nitrospirae_t$tip.label[grepl("QUERY", nitrospirae_t$tip.label)]
nitrospirae_karthik_mrca <- MRCA(karthik_t, nitrospirae_karthik_tips)

faca_t <- extract.clade(reductive_t, faca_mrca)
faca_karthik_tips <- faca_t$tip.label[grepl("QUERY", faca_t$tip.label)]
faca_karthik_mrca <- MRCA(karthik_t, faca_karthik_tips)

envsup1_t <- extract.clade(reductive_t, envsup1_mrca)
envsup1_karthik_tips <- envsup1_t$tip.label[grepl("QUERY", envsup1_t$tip.label)]
envsup1_karthik_mrca <- MRCA(karthik_t, envsup1_karthik_tips)

archaeoglobus_t <- extract.clade(reductive_t, archaeoglobus_mrca)
archaeoglobus_karthik_tips <- archaeoglobus_t$tip.label[grepl("QUERY", archaeoglobus_t$tip.label)]
archaeoglobus_karthik_mrca <- MRCA(karthik_t, archaeoglobus_karthik_tips)

red_arch_t <- extract.clade(reductive_t, red_arch_mrca)
red_arch_karthik_tips <- red_arch_t$tip.label[grepl("QUERY", red_arch_t$tip.label)]
red_arch_karthik_mrca <- MRCA(karthik_t, red_arch_karthik_tips)

```


# tree time
```{r}
ref_tips <- append(subset(ref_seqs, tip_label %in% reductive_tips)$tip_label, subset(karthik_seqs_in_tree, grepl("Moorella", tip_label) == F & !(tip_label %in% long_edge_karthik_seqs_to_drop) & !(tip_label %in% tips_oxidative_mrca))$tip_label)
drop_tips <- setdiff(all_seqs$tip_label, ref_tips)

pruned_t <- drop.tip(rooted_result_tree_f, drop_tips)
reductive_mrca <- MRCA(pruned_t, reductive_tips)
  
reductive_t <- extract.clade(pruned_t, reductive_mrca)

# Trim non-clustered Anantharaman sequences from tree (group closest to reductive archaeal sequences but don’t actually cluster together). These sequences have relatively long branch lengths from any other dsrAB sequences from Mueller 2015's tree. 
# collapse reductive bacterial clade in overall tree
# MRCA will be between archaeoglobus and deltaproteobacteria (take any two random tip labels in these clades)
red_bact_mrca <- MRCA(reductive_t, c("Desulfovibrio_vulgaris_oxamicus__DslVulg9","Archaeoglobus_fulgidus__ArgFulg5"))
red_bact_clade <- extract.clade(reductive_t, node = red_bact_mrca)
red_bact_tips <- red_bact_clade$tip.label

red_arch_clade <- extract.clade(reductive_t, node = red_arch_mrca)
red_arch_tips <- red_arch_clade$tip.label

unclustered_t <- drop.tip(reductive_t, c(red_arch_tips, red_bact_tips))
unclustered_tips <- unclustered_t$tip.label

reductive_t_no_unclustered_tips <- drop.tip(reductive_t, unclustered_tips)

desulfovibrionaceae_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("Desulfovibrionaceae", tax_5))$tip_label)
nitrospirae_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("Nitrospirae", tax_2))$tip_label)
faca_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("FACA", tax_2))$tip_label)
envsup1_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("Environmental supercluster 1", tax_2))$tip_label)
archaeoglobus_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("Archaeoglobus cluster", tax_2))$tip_label)
deltaprot_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("Deltaproteobacteria", tax_2))$tip_label)
red_arch_mrca <- MRCA(reductive_t_no_unclustered_tips, subset(tax_df, grepl("Reductive archaeal", tax_1))$tip_label)

ggtree(reductive_t_no_unclustered_tips, layout = "circular") %>%

collapse(node = MRCA(reductive_t_no_unclustered_tips, subset(tax_df, tax_4 == "Thermodesulfobacteria")$tip_label)) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[1])$tip_label)) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[7])$tip_label)) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[8])$tip_label)) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[10])$tip_label)) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Arctic_sediment_clone_J4-28__Af1t0y27", "Arctic_sediment_clone_AH1_29__AtcSed60"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___rifoxyc3_full_scaffold_48866_dsrB", "Thalassohaline_sediment_clone__FJ588546"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Deep_sea_sediment_clone__UncSu230", "Petroleum-contaminated_sediment_clone__FM212326"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulforhabdus_amnigena__DrhAmni2", "Saltmarsh_clone__UncS1742"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Bioreactor_metagenome__BioMet11", "Pearl_river_estuary_clone_SMTZDsr30__UncS2062"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Arctic_sediment_clone_AH3_22__Bq7a0Ab4", "QUERY___CG1_02_FULL_Deltaproteobacteria_45_11_curated_dsrB"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Schlöppnerbrunnen_I_soil_clone_dsrSbI-82__Af0ScI32", "QUERY___RBG_13_scaffold_9_dsrA"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___RBG_13_scaffold_15836_dsrA", "Polluted_aquifer_clone_LGWK13__UncS1625"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfomicrobium_apsheronum__DscApsh7_AF420281", "Desulfovibrio_aminophilus__DslAmin2"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_africanus__EU716165", "Desulfovibrio_sp._X2__DsvSp235"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Bioreactor_clone__UncS2020", "Bacterium_AR1201__DQ211849"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_vulgaris_oxamicus__DslVulg9", "Desulfovibrio_cuneatus__DslCune3"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_acrylicus__FJ655912", "Desulfovibrio_oceani__FJ655911"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_burkinensis__DslBurk3", "Desulfovibrio_sp._U5L__DsvSp234"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_fructosivorans__DslFruc2", "Bioreactor_clone__UncS2019"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_bastinii__DsvBast3", "Desulfovibrio_hydrothermalis__DsvHydr2"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Desulfovibrio_intestinalis__DslInte3", "Desulfovibrio_intestinalis__DslInte4"))) %>%
  
  # collapsed nodes for faca group
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Seine_river_floodplain_clone_VO4__Bq8Rive4", "Pearl_river_estuary_clone_MidDsr75__UncS2039"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___RBG_13_scaffold_38282_dsrB", "Seine_river_floodplain_clone_VO2__Bq8Rive3"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___rifixya3_full_scaffold_108421_dsrB", "QUERY___Desulfosporosinus_acididurans_dsrB"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___Candidatus_Hydrothermarchaeota_archaeon_JdFR_18_JGI24020J35080_1000151_dsrA", "Rasner_Möser_fen_soil_clone_Rm58__RmRasn11"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Saline-alkaline_soil_clone__JX985645", "QUERY___mol-32-15fa-012545_dsrB"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Rhi-d-50-rice_field_soil__JN615185", "Bacterium_LS1701__DQ211852"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___rifcsp2_19ft_1_scaffold_145950_dsrB", "New_York_peatland_soil_clone_W20__UncSu782"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___Dehalococcoidia_bacterium_SCGC_AB_540_C11_dsrB", "Black_Sea_sediment_clone_BSI-10__BlackSe2"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___rifcsp16_3_sub10_scaffold_10226_dsrB", "Deep_soil_clone_D7__Z17DSoil"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___rifcsp16_3_sub10_scaffold_34522_dsrB", "Hot_spring_microbial_mat_clone__EF429276"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Hydrothermal_field_microbial_mats_clone__AB451525", "QUERY___mol-32-15fa-020022_dsrB"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Pelotomaculum_propionicicum__PtmSpec4", "QUERY___Desulfurispora_thermophila_dsrB"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Deep_sea_sediment_clone__JN798930", "Aarhus_bay_sediment_clone_DSRIV-8__Bv6AaB25"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Deep_sea_sediment_clone_NTd-VI02__UncSu273", "Polluted_aquifer_clone_LGWI13__UncS1646"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___Syntrophomonas_zehnderi_dsrA", "MSW_digester_clone__Unc01cxc"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Black_Sea_sediment_clone_BSI-6__BlackS17", "Hydrothermal_field_microbial_mat_clone__AB451523"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Carboxydothermus_ferrireducens__CrxFerr3", "Carboxydothermus_hydrogenoformans_Z-2901__CrxHydr2"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Thermodesulfobium_narugense__TrfNaru2", "Thermodesulfobium_narugense__CP002690"))) %>%
  
  
  # Env Supercluster 1
  
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___RBG_13_scaffold_1896_dsrB", "QUERY___19ft_2_nophage_noknown_scaffold_70821_dsrB"))) %>%  
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___BJP_IG3402_Desantisbacteria_44_7_dsrB", "Polluted_aquifer_clone_LGWG11__UncS1683"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Uncultured_prokaryote_clone_A24__JQ304764", "QUERY___BJP_IG2599_Bacteria_36_9_dsrA"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___gwc2_scaffold_6304_dsrA", "hydrothermal_vent_sediment_clone_B04P014__HydrVe46")))  %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("New_York_peatland_soil_clone_W9__UncSu779", "Schlöppnerbrunnen_fen_peat_soil_clone__Dsqncy15"))) %>%
  collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___rifcsplowo2_12_scaffold_393080_dsrB", "Schlöppnerbrunnen_fen_peat_soil_clone__DsqnnY12"))) %>%
      collapse(node = MRCA(reductive_t_no_unclustered_tips, c("Seine_estuary_intertidal_zone_clone_VN10__UncS1735", "Aarhus_bay_sediment_clone_DSRIV-10__Bv6AaB23"))) %>%
  
  # archaeoglobus
    collapse(node = MRCA(reductive_t_no_unclustered_tips, c("QUERY___Archaeoglobus_veneficus_dsrB", "QUERY___rifcsphigho2_12_scaffold_694182_dsrB"))) %>%

  # these clades are entirely collapsed bc they have no hit seqs from the HMMER search
  collapse(node = nitrospirae_mrca) %>%
  collapse(node = red_arch_mrca) %<+%
  
  collapsed_nodes_df +
  geom_point2(aes(node = node, size = size_group), alpha = 0.4) +
  
  geom_cladelabel(node = desulfovibrionaceae_mrca, color = "blue", label = "Desulfovibrionaceae", offset = 0.5) +
  geom_cladelabel(node = nitrospirae_mrca, color = "pink", label = "Nitrospirae", align = T) +
  geom_cladelabel(node = faca_mrca, color = "orange", label = "FACA", align = T) +
  geom_cladelabel(node = envsup1_mrca, color = "yellow", label = "Env. Supercluster 1", align = T) +
  geom_cladelabel(node = archaeoglobus_mrca, color = "purple", "Archaeoglobus", align = T) +
  geom_cladelabel(node = deltaprot_mrca, color = "green", "Deltaproteobacteria", align = T) +
  geom_cladelabel(node = red_arch_mrca, color = "red", "Reductive Archaea", align = T) +
  

  geom_point2(aes(subset=(label %in% hit_otus$otu)), color = "red", size = 1) +
  scale_size_manual(na.translate = F, values = c(1, 2, 3))

    # geom_point2(aes(subset=(label %in% ref_seqs$tip_label)), color = "red", size = 1) +
    # geom_tiplab(aes(subset=(grepl("QUERY", label))), size = 1)


```

# identifying clades to collapse
```{r}
# env sub 1
env_tree <- extract.clade(reductive_t, envsup1_mrca)

View(as.data.frame(env_tree$tip.label))

ggtree(env_tree) %>%
  collapse(node = MRCA(env_tree, c("QUERY___RBG_13_scaffold_1896_dsrB", "QUERY___19ft_2_nophage_noknown_scaffold_70821_dsrB"))) %>%  
  collapse(node = MRCA(env_tree, c("QUERY___BJP_IG3402_Desantisbacteria_44_7_dsrB", "Polluted_aquifer_clone_LGWG11__UncS1683"))) %>%
  collapse(node = MRCA(env_tree, c("Uncultured_prokaryote_clone_A24__JQ304764", "QUERY___BJP_IG2599_Bacteria_36_9_dsrA"))) %>%
  collapse(node = MRCA(env_tree, c("QUERY___gwc2_scaffold_6304_dsrA", "hydrothermal_vent_sediment_clone_B04P014__HydrVe46")))  %>%
  collapse(node = MRCA(env_tree, c("New_York_peatland_soil_clone_W9__UncSu779", "Schlöppnerbrunnen_fen_peat_soil_clone__Dsqncy15"))) %>%
  collapse(node = MRCA(env_tree, c("QUERY___rifcsplowo2_12_scaffold_393080_dsrB", "Schlöppnerbrunnen_fen_peat_soil_clone__DsqnnY12"))) %>%
  
    collapse(node = MRCA(env_tree, c("Seine_estuary_intertidal_zone_clone_VN10__UncS1735", "Aarhus_bay_sediment_clone_DSRIV-10__Bv6AaB23"))) +

  
  geom_cladelabel(label = Ntip(extract.clade(env_tree, MRCA(env_tree, c("QUERY___RBG_13_scaffold_1896_dsrB", "QUERY___19ft_2_nophage_noknown_scaffold_70821_dsrB")))), node = MRCA(env_tree, c("QUERY___RBG_13_scaffold_1896_dsrB", "QUERY___19ft_2_nophage_noknown_scaffold_70821_dsrB"))) +
  geom_cladelabel(label = Ntip(extract.clade(env_tree, MRCA(env_tree, c("Uncultured_prokaryote_clone_A24__JQ304764", "QUERY___BJP_IG2599_Bacteria_36_9_dsrA")))), node = MRCA(env_tree, c("Uncultured_prokaryote_clone_A24__JQ304764", "QUERY___BJP_IG2599_Bacteria_36_9_dsrA"))) +
  geom_cladelabel(label = Ntip(extract.clade(env_tree, MRCA(env_tree, c("QUERY___gwc2_scaffold_6304_dsrA", "hydrothermal_vent_sediment_clone_B04P014__HydrVe46")))), node = MRCA(env_tree, c("QUERY___gwc2_scaffold_6304_dsrA", "hydrothermal_vent_sediment_clone_B04P014__HydrVe46"))) +
  geom_cladelabel(label = Ntip(extract.clade(env_tree, MRCA(env_tree, c("New_York_peatland_soil_clone_W9__UncSu779", "Schlöppnerbrunnen_fen_peat_soil_clone__Dsqncy15")))), node = MRCA(env_tree, c("New_York_peatland_soil_clone_W9__UncSu779", "Schlöppnerbrunnen_fen_peat_soil_clone__Dsqncy15"))) +
  geom_cladelabel(label = Ntip(extract.clade(env_tree, MRCA(env_tree, c("QUERY___rifcsplowo2_12_scaffold_393080_dsrB", "Schlöppnerbrunnen_fen_peat_soil_clone__DsqnnY12")))), node = MRCA(env_tree, c("QUERY___rifcsplowo2_12_scaffold_393080_dsrB", "Schlöppnerbrunnen_fen_peat_soil_clone__DsqnnY12"))) +
  geom_cladelabel(label = Ntip(extract.clade(env_tree, MRCA(env_tree, c("QUERY___BJP_IG3402_Desantisbacteria_44_7_dsrB", "Polluted_aquifer_clone_LGWG11__UncS1683")))), node = MRCA(env_tree, c("QUERY___BJP_IG3402_Desantisbacteria_44_7_dsrB", "Polluted_aquifer_clone_LGWG11__UncS1683"))) +
  geom_tiplab(size = 2, hjust = 0.8) +
  # geom_nodepoint() +
  geom_point2(aes(subset=(label %in% hit_otus$otu)), color = "red", size = 2, alpha = 0.7)

```

# faca group collapsing nodes
```{r}
faca_tree <- extract.clade(reductive_t_no_unclustered_tips, faca_mrca)

View(as.data.frame(faca_tree$tip.label))

ggtree(faca_tree) %>%
  collapse(node = MRCA(faca_tree, c("Seine_river_floodplain_clone_VO4__Bq8Rive4", "Pearl_river_estuary_clone_MidDsr75__UncS2039"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___RBG_13_scaffold_38282_dsrB", "Seine_river_floodplain_clone_VO2__Bq8Rive3"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___rifixya3_full_scaffold_108421_dsrB", "QUERY___Desulfosporosinus_acididurans_dsrB"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___Candidatus_Hydrothermarchaeota_archaeon_JdFR_18_JGI24020J35080_1000151_dsrA", "Rasner_Möser_fen_soil_clone_Rm58__RmRasn11"))) %>%
  collapse(node = MRCA(faca_tree, c("Saline-alkaline_soil_clone__JX985645", "QUERY___mol-32-15fa-012545_dsrB"))) %>%
  collapse(node = MRCA(faca_tree, c("Rhi-d-50-rice_field_soil__JN615185", "Bacterium_LS1701__DQ211852"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___rifcsp2_19ft_1_scaffold_145950_dsrB", "New_York_peatland_soil_clone_W20__UncSu782"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___Dehalococcoidia_bacterium_SCGC_AB_540_C11_dsrB", "Black_Sea_sediment_clone_BSI-10__BlackSe2"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___rifcsp16_3_sub10_scaffold_10226_dsrB", "Deep_soil_clone_D7__Z17DSoil"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___rifcsp16_3_sub10_scaffold_34522_dsrB", "Hot_spring_microbial_mat_clone__EF429276"))) %>%
  collapse(node = MRCA(faca_tree, c("Hydrothermal_field_microbial_mats_clone__AB451525", "QUERY___mol-32-15fa-020022_dsrB"))) %>%
  collapse(node = MRCA(faca_tree, c("Pelotomaculum_propionicicum__PtmSpec4", "QUERY___Desulfurispora_thermophila_dsrB"))) %>%
  collapse(node = MRCA(faca_tree, c("Deep_sea_sediment_clone__JN798930", "Aarhus_bay_sediment_clone_DSRIV-8__Bv6AaB25"))) %>%
  collapse(node = MRCA(faca_tree, c("Deep_sea_sediment_clone_NTd-VI02__UncSu273", "Polluted_aquifer_clone_LGWI13__UncS1646"))) %>%
  collapse(node = MRCA(faca_tree, c("QUERY___Syntrophomonas_zehnderi_dsrA", "MSW_digester_clone__Unc01cxc"))) %>%
  collapse(node = MRCA(faca_tree, c("Black_Sea_sediment_clone_BSI-6__BlackS17", "Hydrothermal_field_microbial_mat_clone__AB451523"))) %>%
  collapse(node = MRCA(faca_tree, c("Carboxydothermus_ferrireducens__CrxFerr3", "Carboxydothermus_hydrogenoformans_Z-2901__CrxHydr2"))) %>%
  collapse(node = MRCA(faca_tree, c("Thermodesulfobium_narugense__TrfNaru2", "Thermodesulfobium_narugense__CP002690"))) +
  
  geom_tiplab(size = 1.5, hjust = 0.5) +
  geom_point2(aes(subset=(label %in% hit_otus$otu)), color = "red", size = 1)

```

# enf supgroup 1
```{r}
# env sub 1
deltaprot_tree <- extract.clade(reductive_t, deltaprot_mrca)

View(as.data.frame(deltaprot_tree$tip.label))

ggtree(deltaprot_tree) %>%
  # collapse(node = MRCA(deltaprot_tree, subset(tax_df, grepl("Desulfovibrionaceae", tax_5))$tip_label)) %>%
  collapse(node = MRCA(deltaprot_tree, subset(tax_df, tax_4 == "Thermodesulfobacteria")$tip_label)) %>%
  collapse(node = MRCA(deltaprot_tree, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[1])$tip_label)) %>%
  collapse(node = MRCA(deltaprot_tree, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[7])$tip_label)) %>%
  collapse(node = MRCA(deltaprot_tree, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[8])$tip_label)) %>%
  collapse(node = MRCA(deltaprot_tree, subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[10])$tip_label)) %>%

  collapse(node = MRCA(deltaprot_tree, c("Arctic_sediment_clone_J4-28__Af1t0y27", "Arctic_sediment_clone_AH1_29__AtcSed60"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("QUERY___rifoxyc3_full_scaffold_48866_dsrB", "Thalassohaline_sediment_clone__FJ588546"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Deep_sea_sediment_clone__UncSu230", "Petroleum-contaminated_sediment_clone__FM212326"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulforhabdus_amnigena__DrhAmni2", "Saltmarsh_clone__UncS1742"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Bioreactor_metagenome__BioMet11", "Pearl_river_estuary_clone_SMTZDsr30__UncS2062"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Arctic_sediment_clone_AH3_22__Bq7a0Ab4", "QUERY___CG1_02_FULL_Deltaproteobacteria_45_11_curated_dsrB"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Schlöppnerbrunnen_I_soil_clone_dsrSbI-82__Af0ScI32", "QUERY___RBG_13_scaffold_9_dsrA"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("QUERY___RBG_13_scaffold_15836_dsrA", "Polluted_aquifer_clone_LGWK13__UncS1625"))) %>%
  
  collapse(node = MRCA(deltaprot_tree, c("Desulfomicrobium_apsheronum__DscApsh7_AF420281", "Desulfovibrio_aminophilus__DslAmin2"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_africanus__EU716165", "Desulfovibrio_sp._X2__DsvSp235"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Bioreactor_clone__UncS2020", "Bacterium_AR1201__DQ211849"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_vulgaris_oxamicus__DslVulg9", "Desulfovibrio_cuneatus__DslCune3"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_acrylicus__FJ655912", "Desulfovibrio_oceani__FJ655911"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_burkinensis__DslBurk3", "Desulfovibrio_sp._U5L__DsvSp234"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_fructosivorans__DslFruc2", "Bioreactor_clone__UncS2019"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_bastinii__DsvBast3", "Desulfovibrio_hydrothermalis__DsvHydr2"))) %>%
  collapse(node = MRCA(deltaprot_tree, c("Desulfovibrio_intestinalis__DslInte3", "Desulfovibrio_intestinalis__DslInte4"))) +
  
  
  geom_tiplab(size = 1.5) +
  
  # geom_point2(aes(subset=(label %in% hit_otus$otu)), color = "red", size = 1)



```

# archaeoglobus
```{r}
# archaeoglobus
arch_tree <- extract.clade(reductive_t, archaeoglobus_mrca)

View(as.data.frame(arch_tree$tip.label))

ggtree(arch_tree) %>%
  collapse(node = MRCA(arch_tree, c("QUERY___Archaeoglobus_veneficus_dsrB", "QUERY___rifcsphigho2_12_scaffold_694182_dsrB"))) +
  geom_tiplab(size = 2, hjust = 1.8) +
  geom_point2(aes(subset=(label %in% hit_otus$otu)), color = "red", size = 1)

```

# Trim non-clustered Anantharaman sequences from tree (group closest to reductive archaeal sequences but don’t actually cluster together). These sequences have relatively long branch lengths from any other dsrAB sequences from Mueller 2015's tree. 
```{r}
# collapse reductive bacterial clade in overall tree
# MRCA will be between archaeoglobus and deltaproteobacteria (take any two random tip labels in these clades)
red_bact_mrca <- MRCA(reductive_t, c("Desulfovibrio_vulgaris_oxamicus__DslVulg9","Archaeoglobus_fulgidus__ArgFulg5"))
red_bact_clade <- extract.clade(reductive_t, node = red_bact_mrca)
red_bact_tips <- red_bact_clade$tip.label

red_arch_clade <- extract.clade(reductive_t, node = red_arch_mrca)
red_arch_tips <- red_arch_clade$tip.label

unclustered_t <- drop.tip(reductive_t, c(red_arch_tips, red_bact_tips))
unclustered_tips <- unclustered_t$tip.label

```

# 
```{r}
tip_in_nodes_list <- list(
  # deltaproteobacteria
  c(subset(tax_df, tax_4 == "Thermodesulfobacteria")$tip_label),
  c(subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[1])$tip_label),
  c(subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[7])$tip_label),
  c(subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[8])$tip_label),
  c(subset(tax_df, tax_5 == unique(subset(tax_df, tax_2 == "Deltaproteobacteria supercluster" & tax_4 != "Clostridia" & tax_4 != "Thermodesulfobacteria" & tax_5 != "Desulfovibrionaceae" & tax_5 != "Unclassified")$tax_5)[10])$tip_label),
  (c("Arctic_sediment_clone_J4-28__Af1t0y27", "Arctic_sediment_clone_AH1_29__AtcSed60")),
  (c("QUERY___rifoxyc3_full_scaffold_48866_dsrB", "Thalassohaline_sediment_clone__FJ588546")),
  (c("Deep_sea_sediment_clone__UncSu230", "Petroleum-contaminated_sediment_clone__FM212326")),
  (c("Desulforhabdus_amnigena__DrhAmni2", "Saltmarsh_clone__UncS1742")),
  (c("Bioreactor_metagenome__BioMet11", "Pearl_river_estuary_clone_SMTZDsr30__UncS2062")),
  (c("Arctic_sediment_clone_AH3_22__Bq7a0Ab4", "QUERY___CG1_02_FULL_Deltaproteobacteria_45_11_curated_dsrB")),
  (c("Schlöppnerbrunnen_I_soil_clone_dsrSbI-82__Af0ScI32", "QUERY___RBG_13_scaffold_9_dsrA")),
  (c("QUERY___RBG_13_scaffold_15836_dsrA", "Polluted_aquifer_clone_LGWK13__UncS1625")),
  (c("Desulfomicrobium_apsheronum__DscApsh7_AF420281", "Desulfovibrio_aminophilus__DslAmin2")),
  (c("Desulfovibrio_africanus__EU716165", "Desulfovibrio_sp._X2__DsvSp235")),
  (c("Bioreactor_clone__UncS2020", "Bacterium_AR1201__DQ211849")),
  (c("Desulfovibrio_vulgaris_oxamicus__DslVulg9", "Desulfovibrio_cuneatus__DslCune3")),
  (c("Desulfovibrio_acrylicus__FJ655912", "Desulfovibrio_oceani__FJ655911")),
  (c("Desulfovibrio_burkinensis__DslBurk3", "Desulfovibrio_sp._U5L__DsvSp234")),
  (c("Desulfovibrio_fructosivorans__DslFruc2", "Bioreactor_clone__UncS2019")),
  (c("Desulfovibrio_bastinii__DsvBast3", "Desulfovibrio_hydrothermalis__DsvHydr2")),
  (c("Desulfovibrio_intestinalis__DslInte3", "Desulfovibrio_intestinalis__DslInte4")),
  
  # faca group
  (c("Seine_river_floodplain_clone_VO4__Bq8Rive4", "Pearl_river_estuary_clone_MidDsr75__UncS2039")),
  (c("QUERY___RBG_13_scaffold_38282_dsrB", "Seine_river_floodplain_clone_VO2__Bq8Rive3")),
  (c("QUERY___rifixya3_full_scaffold_108421_dsrB", "QUERY___Desulfosporosinus_acididurans_dsrB")),
  (c("QUERY___Candidatus_Hydrothermarchaeota_archaeon_JdFR_18_JGI24020J35080_1000151_dsrA", "Rasner_Möser_fen_soil_clone_Rm58__RmRasn11")),
  (c("Saline-alkaline_soil_clone__JX985645", "QUERY___mol-32-15fa-012545_dsrB")),
  (c("Rhi-d-50-rice_field_soil__JN615185", "Bacterium_LS1701__DQ211852")),
  (c("QUERY___rifcsp2_19ft_1_scaffold_145950_dsrB", "New_York_peatland_soil_clone_W20__UncSu782")),
  (c("QUERY___Dehalococcoidia_bacterium_SCGC_AB_540_C11_dsrB", "Black_Sea_sediment_clone_BSI-10__BlackSe2")),
  (c("QUERY___rifcsp16_3_sub10_scaffold_10226_dsrB", "Deep_soil_clone_D7__Z17DSoil")),
  (c("QUERY___rifcsp16_3_sub10_scaffold_34522_dsrB", "Hot_spring_microbial_mat_clone__EF429276")),
  (c("Hydrothermal_field_microbial_mats_clone__AB451525", "QUERY___mol-32-15fa-020022_dsrB")),
  (c("Pelotomaculum_propionicicum__PtmSpec4", "QUERY___Desulfurispora_thermophila_dsrB")),
  (c("Deep_sea_sediment_clone__JN798930", "Aarhus_bay_sediment_clone_DSRIV-8__Bv6AaB25")),
  (c("Deep_sea_sediment_clone_NTd-VI02__UncSu273", "Polluted_aquifer_clone_LGWI13__UncS1646")),
  (c("QUERY___Syntrophomonas_zehnderi_dsrA", "MSW_digester_clone__Unc01cxc")),
  (c("Black_Sea_sediment_clone_BSI-6__BlackS17", "Hydrothermal_field_microbial_mat_clone__AB451523")),
  (c("Carboxydothermus_ferrireducens__CrxFerr3", "Carboxydothermus_hydrogenoformans_Z-2901__CrxHydr2")),
  (c("Thermodesulfobium_narugense__TrfNaru2", "Thermodesulfobium_narugense__CP002690")),
  
  # Env Supercluster 1
  (c("QUERY___RBG_13_scaffold_1896_dsrB", "QUERY___19ft_2_nophage_noknown_scaffold_70821_dsrB")),  
  (c("QUERY___BJP_IG3402_Desantisbacteria_44_7_dsrB", "Polluted_aquifer_clone_LGWG11__UncS1683")),
  (c("Uncultured_prokaryote_clone_A24__JQ304764", "QUERY___BJP_IG2599_Bacteria_36_9_dsrA")),
  (c("QUERY___gwc2_scaffold_6304_dsrA", "hydrothermal_vent_sediment_clone_B04P014__HydrVe46")),
  (c("New_York_peatland_soil_clone_W9__UncSu779", "Schlöppnerbrunnen_fen_peat_soil_clone__Dsqncy15")),
  (c("QUERY___rifcsplowo2_12_scaffold_393080_dsrB", "Schlöppnerbrunnen_fen_peat_soil_clone__DsqnnY12")),
  (c("Seine_estuary_intertidal_zone_clone_VN10__UncS1735", "Aarhus_bay_sediment_clone_DSRIV-10__Bv6AaB23")),
  
  # archaeoglobus
  (c("QUERY___Archaeoglobus_veneficus_dsrB", "QUERY___rifcsphigho2_12_scaffold_694182_dsrB")))

nodes <- c()

for (n in 1:length(tip_in_nodes_list)) {
  node <- MRCA(reductive_t_no_unclustered_tips, tip_in_nodes_list[[n]])
  nodes <- append(nodes, node)
}

collapsed_nodes_df <- data.frame(node = nodes)

get_n_tips <- function(node, tree) {
  clade <- extract.clade(tree, node)
  return(Ntip(clade))
}

collapsed_nodes_df <- collapsed_nodes_df %>%
  rowwise() %>%
  mutate(n_tips = get_n_tips(node, reductive_t_no_unclustered_tips)) %>%
  mutate(size_group = case_when(n_tips < 10 ~ "<10", 
                                n_tips >= 10 & n_tips <= 100 ~ "10-100", 
                                n_tips > 100 ~ ">100"))

```



