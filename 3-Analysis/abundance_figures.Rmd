---
title: "abundance_figures"
date: "25 November 2025"
output: html_document
author: "Elizabeth Daigle"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Read in packages and functions
```{r}
source(paste0(here::here(), "/1-Config/config.R"))
```

```{r}
samples_unique_gene_casette <- readRDS(paste0(dataDir, "/samples_unique_genes_with_names_2015.rds"))
```

```{r}
#looking to see which contigs are mapping to several species
contigs_multiple_refs <- samples_unique_gene_casette %>%
  group_by(contig) %>%
  filter(n_distinct(single_closest_ref) > 1)%>%
  # filter out contigs where multiple species are both Bilophila species or both D. piger
  # want to fix the contigs mapping to species that are farther apart on the tree
  filter(!all(grepl("Bil|piger", single_closest_ref))) %>%
  summarize(
    n_refs = n_distinct(single_closest_ref),
    refs = paste(unique(single_closest_ref), collapse = "; ")
  )
```

# choose a representative subunit
```{r}
# manually select a subunit for the 6 contigs found in contigs_multiple_refs
partial_genes <- c("Capsule_14.k141_153065_1", "Stool_14.k141_240693_1", "Stool_9.k141_270672_1")
unknown_species <- c("Capsule_7.k141_250498_14", "Stool_7.k141_215370_50")

samples_unique_subunit_manual <- samples_unique_gene_casette %>%
  filter(!geneNum %in% partial_genes) %>%
  filter(!geneNum %in% unknown_species)

samples_unique_subunit_RPKM <- samples_unique_subunit_manual %>%
  filter(single_closest_ref != "Moorella_thermoacetica_Y72_copy_2__MooTher5") %>%
  group_by(contig, sample) %>%
  slice_max(RPKM, n = 1, with_ties = FALSE) %>%
  ungroup()
```

## get summary statistics for text
```{r}
# we want to know the number of unique hits in a coassembly (do not double-count contigs that show up in different samples)
# so select one subunit per **coassembly**; this is accomplished by grouping by subject and contig
unique_hits_summary <- samples_unique_gene_casette %>%
  filter(single_closest_ref != "Moorella_thermoacetica_Y72_copy_2__MooTher5") %>%
  group_by(subject, contig, sample_type) %>%
  slice_max(RPKM, n = 1, with_ties = FALSE) %>%
  # find the number of unique hits for each subject for stool and capsule
  group_by(subject, sample_type) %>%
  summarize(number_hits=n()) %>%
  # take the median
  group_by(sample_type) %>%
  summarize(n_hits_total=sum(number_hits), median_hits=median(number_hits), q_25=quantile(number_hits, probs=0.25), q_75=quantile(number_hits, probs=0.75))
```

## get summary statistics for figure 4A 
```{r}
capsule_type_summary <- samples_unique_subunit_RPKM %>%
  # find the number of genes in each sample and the sum of their RPKMs
  group_by(sample, subject, Type) %>%
  summarise(n_genes = n(), 
            total_rpkm = sum(RPKM)) %>%
  ungroup() %>% 
  # find the median number of genes and median RPKM sum for all of the samples for a given subject and Type
  # need this center chunk because different subjects have different numbers of samples!
  group_by(subject, Type) %>%
  summarise(n_median = median(n_genes),
            median_total_rpkm = median(total_rpkm)) %>%
  ungroup() %>%
  # find the median number of genes and median RPKM sum for each Type
  group_by(Type) %>% 
  summarise(n_subjects=n_distinct(subject),
            n_median_all_subj = round(median(n_median),2),
            n_25pct = round(quantile(n_median, probs = 0.25),2),
            n_75pct = round(quantile(n_median, probs = 0.75),2),
            median_rpkm_all_subj = round(median(median_total_rpkm),2),
            rpkm_25pct = round(quantile(median_total_rpkm, probs = 0.25),2),
            rpkm_75pct = round(quantile(median_total_rpkm, probs = 0.75),2)) %>% 
  mutate(n_genes_per_sample = paste0(n_median_all_subj, " (", n_25pct, ", ", n_75pct, ")"),
         median_rpkm_per_sample = paste0(median_rpkm_all_subj, " (", rpkm_25pct, ", ", rpkm_75pct, ")")) %>%
  select(Type, n_subjects, n_genes_per_sample, median_rpkm_per_sample)

```


# color palettes for plots
```{r}
# Generate a viridis palette with 20 colors
viridis_palette <- viridis(20)
viridis_palette

boxplot_colors <- c(viridis_palette[6], viridis_palette[16])

jitter_colors <- c("#4477AA", "#59A075", "#AA3377", "#DDAA33", "#6F7042")


#set 3+5 are after dinner and 2+4 are afternoon
set_colors <- c("#fd8d3c", "light sky blue", "#d94701", "navy", "#6F7042")
```

# Change species labels
```{r}
species <- unique(samples_unique_subunit_RPKM$single_closest_ref)

species_labels <- c("Desulfitibacter_alkalitolerans__DfiAlka2" = "Desulfitibacter alkalitolerans",
                    "Desulfovibrio_piger__DslPige3" = "Desulfovibrio piger 3",
                    "Desulfovibrio_piger__DslPige4" = "Desulfovibrio piger 4",
                    "Bilophila_wadsworthia__BilWads6" = "Bilophila wadsworthia 6",
                    "uncultured_bacterium__EF645667" = "Desulfovibrio desulfuricans",
                    "Bilophila_sp._4_1_30__BilSpec3" = "Bilophila species 3",
                    "Gordonibacter_pamelaeae__GrdPame5" = "Gordonibacter pamelaeae",
                    "Moorella_thermoacetica_Y72_copy_2__MooTher5" = "Moorella thermoacetica",
                    "Anaerobic_bacterium_sk.prop8__Bv2Prop2" = "Anaerobic bacterium")

species_labels_combine_species <- c("Desulfitibacter_alkalitolerans__DfiAlka2" = "italic(Desulfitibacter~alkalitolerans)",
                    "Desulfovibrio_piger" = "italic(Desulfovibrio~piger)",
                    "Bilophila_species" = "italic(Bilophila)~species",
                    "uncultured_bacterium__EF645667" = "italic(Desulfovibrio~desulfuricans)",
                    "Gordonibacter_pamelaeae__GrdPame5" = "italic(Gordonibacter~pamelaeae)",
                    "Moorella_thermoacetica_Y72_copy_2__MooTher5" = "italic(Moorella~thermoacetica)",
                    "Anaerobic_bacterium_sk.prop8__Bv2Prop2" = "'Anaerobic bacterium'")
```

# SUPP. FIG. 5
# plot RPKM for unique genes (each hit would be one subunit) in each sample to compare between location; facet by species and subject
# this plot combines the two D. piger and two B. wadsworthia species
```{r}
samples_unique_subunit_RPKM %>%
  #remove moorella because its distance from the queries is 7.5 (all others are less than 2.5)
  filter(single_closest_ref != "Moorella_thermoacetica_Y72_copy_2__MooTher5") %>%
  mutate(combine_species = case_when(
    single_closest_ref %in% c("Desulfovibrio_piger__DslPige3", "Desulfovibrio_piger__DslPige4") ~ "Desulfovibrio_piger",
    single_closest_ref %in% c("Bilophila_wadsworthia__BilWads6", "Bilophila_sp._4_1_30__BilSpec3") ~ "Bilophila_species",
    TRUE ~ single_closest_ref)) %>%
  mutate(combine_species = factor(combine_species, 
                                  levels = c("Desulfovibrio_piger", 
                                            "uncultured_bacterium__EF645667",
                                            "Bilophila_species",
                                            "Desulfitibacter_alkalitolerans__DfiAlka2",
                                            "Gordonibacter_pamelaeae__GrdPame5",
                                            "Anaerobic_bacterium_sk.prop8__Bv2Prop2"))) %>%
  mutate(combine_species = recode(combine_species, !!!species_labels_combine_species)) %>%
  # order subjects based on heatmap order
  mutate(subject = factor(subject, levels = c("12", "9", "14", "2", "13", "7", "3", "6", "4", "11", "1"))) %>%
  ggplot(aes(x = Type, y = log10(RPKM))) +
  geom_boxplot(color = "black",
               position = position_dodge(width = 0.8), size = 0.8, outlier.shape = NA) +
  geom_jitter(aes(color = Type),
            alpha = 1.6,
            position = position_jitterdodge(
        jitter.width = 0.5,
        dodge.width = 0.8)) +
  scale_color_manual(values = jitter_colors) +
  #get rid of box fill
  scale_fill_manual(values = c("transparent", "transparent", "transparent", "transparent", "transparent"), guide = "none") +
  guides(fill = "none") +
  guides(
    color = guide_legend(
      override.aes = list(size = 4)
    )) +
  facet_grid(subject ~ combine_species, 
             #scale = "free_y",
             labeller = labeller(combine_species = label_parsed)) +
  labs(
    title = expression(paste(italic("dsrAB"), " gene cluster abundance across species by type")),
    x = "Type",
    y = "log10(RPKM)",
    color = "Type"
  ) +
  theme_bw() +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 14),
    legend.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    axis.text.x = element_text(size = 14, angle = 60, hjust = 1),
    axis.text.y = element_text(size = 12),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    plot.title = element_text(size = 20, hjust = 0.5)
  )
#ggsave("dsrAB_RPKM_combine_species_free_y_axis.png",
ggsave("dsrAB_RPKM_combine_species.png",
       width = 18, height = 14, units = "in",   # increase for larger output
       dpi = 600)
```

## sampling variability for subject 9 FIGURE 5
```{r}
plot_subj9 <- samples_unique_subunit_RPKM %>%
  filter(!Set %in% c(1,6,7,8,9,10,11,12,13)) %>%
  filter(subject == 9 ) %>%
  mutate(combine_species = case_when(
    single_closest_ref %in% c("Desulfovibrio_piger__DslPige3", "Desulfovibrio_piger__DslPige4") ~ "Desulfovibrio_piger",
    single_closest_ref %in% c("Bilophila_wadsworthia__BilWads6", "Bilophila_sp._4_1_30__BilSpec3") ~ "Bilophila_species",
    TRUE ~ single_closest_ref)) %>%
  mutate(combine_species = factor(combine_species, 
                                  levels = c("Desulfovibrio_piger", 
                                            "uncultured_bacterium__EF645667",
                                            "Bilophila_species",
                                            "Desulfitibacter_alkalitolerans__DfiAlka2",
                                            "Gordonibacter_pamelaeae__GrdPame5",
                                            "Anaerobic_bacterium_sk.prop8__Bv2Prop2"))) %>%
  mutate(combine_species = recode(combine_species, !!!species_labels_combine_species)) 

# Get contigs per species
contigs_by_species <- plot_subj9 %>%
  group_by(combine_species) %>%
  summarize(contigs = list(unique(contig))) 

# Generate shades automatically
contig_colors <- c(
  setNames(
    colorspace::sequential_hcl(n = length(contigs_by_species$contigs[[1]]), palette = "Greens", l = c(20, 80)),
    contigs_by_species$contigs[[1]]
  ),
  setNames(
    colorspace::sequential_hcl(n = length(contigs_by_species$contigs[[2]]), palette = "Reds", l = c(20, 80)),
    contigs_by_species$contigs[[2]]
  ),
  setNames(
    colorspace::sequential_hcl(n = length(contigs_by_species$contigs[[3]]), palette = "Oranges", l = c(20, 80)),
    contigs_by_species$contigs[[3]]
  )
)


ggplot(plot_subj9, 
       aes(x = Set, y = log10(RPKM), group = interaction(Type, contig), color = contig)) + 
  geom_point() + 
  geom_line() + 
  facet_grid(combine_species~Type,
             labeller = labeller(combine_species = label_parsed)) 

+
  scale_color_manual(values = contig_colors)



ggsave("dsrAB_RPKM_combine_species_wCollectionTimes_sub9.png",
       width = 12, height = 6, units = "in",   # increase for larger output
       dpi = 600)

```


# HEATMAP FIGURE 4B
# Heatmap for capsule vs stool 
# in one plot
```{r}
#extract species, subject, RPKM columns to make a matrix that has subjects as row names and species as column names
median_RPKM_by_sample_type <- samples_unique_subunit_RPKM %>%
  # remove moorella thermoacetica, distance is too far
  filter(single_closest_ref != "Moorella_thermoacetica_Y72_copy_2__MooTher5") %>%
  # combine d. piger and bilophila species
  mutate(combine_species = case_when(
    single_closest_ref %in% c("Desulfovibrio_piger__DslPige3", "Desulfovibrio_piger__DslPige4") ~ "Desulfovibrio_piger",
    single_closest_ref %in% c("Bilophila_wadsworthia__BilWads6", "Bilophila_sp._4_1_30__BilSpec3") ~ "Bilophila_species",
    TRUE ~ single_closest_ref)) %>%
  mutate(subject_sample_type=paste(subject,sample_type, sep = "_")) %>%
  group_by(subject_sample_type, combine_species) %>%
  summarize(sum_RPKM=sum(RPKM))%>%
  pivot_wider(
    names_from = combine_species,
    values_from = sum_RPKM,
    values_fill = 0) %>%
    column_to_rownames(., var = "subject_sample_type")

# transform  
matrix_sample_type_log <- round(log10(median_RPKM_by_sample_type + 1),4) %>%
  as.matrix()
```

```{r}
row_subjects_2 <- sapply(strsplit(rownames(matrix_sample_type_log), "_"), function(x) x[1])
row_types_2 <- sapply(strsplit(rownames(matrix_sample_type_log), "_"), function(x) x[2])



species_labels_combine_species_no_moorella <- c("Desulfitibacter_alkalitolerans__DfiAlka2" = "italic(Desulfitibacter~alkalitolerans)",
                    "Desulfovibrio_piger" = "italic(Desulfovibrio~piger)",
                    "Bilophila_species" = "italic(Bilophila)~species",
                    "uncultured_bacterium__EF645667" = "italic(Desulfovibrio~desulfuricans)",
                    "Gordonibacter_pamelaeae__GrdPame5" = "italic(Gordonibacter~pamelaeae)",
                    "Anaerobic_bacterium_sk.prop8__Bv2Prop2" = "'Anaerobic bacterium'")
col_labels_sample_type <- species_labels_combine_species_no_moorella[colnames(matrix_sample_type_log)]
col_labels_sample_type_parsed <- parse(text = col_labels_sample_type)
```

```{r}
# Create stool and capsule matrices
matrix_capsule <- matrix_sample_type_log[row_types_2 == "Capsule", ]
matrix_stool <- matrix_sample_type_log[row_types_2 == "Stool", ]

# Make sure columns are in the same order for both
common_cols <- intersect(colnames(matrix_capsule), colnames(matrix_stool))

subjects_capsule <- sapply(strsplit(rownames(matrix_capsule), "_"), function(x) x[1])
subjects_stool <- sapply(strsplit(rownames(matrix_stool), "_"), function(x) x[1])

# Use capsule subjects as the complete list (since it has 2 extra subjects)
all_subjects <- subjects_capsule

# Stool matrix already matches capsule dimensions, just needs to be expanded
n_cols <- ncol(matrix_capsule)

# Initialize stool matrix with zeros for all capsule subjects
matrix_stool_complete <- matrix(0, nrow = length(all_subjects), ncol = n_cols)
rownames(matrix_stool_complete) <- all_subjects
colnames(matrix_stool_complete) <- colnames(matrix_stool)

# Fill in the stool values that exist
for(i in 1:length(subjects_stool)) {
  subject <- subjects_stool[i]
  if(subject %in% all_subjects) {
    matrix_stool_complete[subject, ] <- matrix_stool[i, ]
  }
}

# Capsule matrix just needs subject names
rownames(matrix_capsule) <- subjects_capsule

# Now matrix_capsule and matrix_stool_complete have the same dimensions
# with 0 for subjects that don't appear in stool

species_order <- names(species_labels_combine_species_no_moorella)

matrix_capsule <- matrix_capsule[, species_order]
matrix_stool_complete <- matrix_stool_complete[, species_order]

# Color functions for each group (using same scale for comparability)
all_values <- c(as.vector(matrix_capsule), as.vector(matrix_stool_complete))
min_val <- min(all_values, na.rm = TRUE)
max_val <- max(all_values, na.rm = TRUE)

col_fun <- colorRamp2::colorRamp2(seq(min_val, max_val, length.out = 50), 
                       viridis(50, begin = 0.95, end = 0.1))


# Create custom cell function to draw split cells
cell_func_hm <- function(j, i, x, y, width, height, fill) {
  # Get values from both groups
  val1 <- matrix_capsule[i, j]
  val2 <- matrix_stool_complete[i, j]
  
  # Draw left half (capsule)

  fill1 <- if (val1 == 0) {
      "gray90"
    } else {
     col_fun(val1)
   }
  grid.rect(x = x - width/4, y = y, 
            width = width/2, height = height,
            gp = gpar(col = NA, lwd = 0.5, fill = fill1))
  
  
  # Draw right half (stool)  
  fill2 <- if (val2 == 0) {
      "gray90"
    } else {
      col_fun(val2)
    }
  grid.rect(x = x + width/4, y = y,
            width = width/2, height = height,
            gp = gpar(col = NA, lwd = 0.5, fill = fill2))
 
  grid.rect(
    x = x, y = y,
    width = width, height = height,
    gp = gpar(col = "white", lwd = 0.4, fill = NA))
}

# Prepare column labels
col_labels_parsed_split <- parse(text = species_labels_combine_species_no_moorella[colnames(matrix_capsule)])

```


```{r}
png("heatmap_split.png", width = 8, height = 6, units = "in", res = 600)

hm_split <- pheatmap(
  matrix_capsule,  # Use capsule as base since it has the right # of subjects (colors handled by cell_fun)
  name = "log10(sum of RPKM)",
  cell_fun = cell_func_hm,
  col = viridis(50, begin = 0.95, end = 0.1),  # For legend
  cluster_rows = TRUE,
  cluster_cols = FALSE,
  clustering_distance_rows = "euclidean",
  clustering_method = 'ward.D',

  show_rownames = TRUE,
  show_colnames = TRUE,
  angle_col = "45",
  labels_col = col_labels_parsed_split,
  
  show_row_dend = FALSE,
  show_column_dend = FALSE,
  
  column_title = expression(paste(italic("dsrAB"), " gene cluster abundance across species by sample type")),
  row_names_side = "left",
  row_title = "Subject",
  row_title_side = "left",
  
  heatmap_legend_param = list(
    title = "log10(sum of RPKM)",
    legend_height = unit(4, "cm"),
    at = seq(min_val, max_val, length.out = 5),
    labels = sprintf("%.2f", seq(min_val, max_val, length.out = 5))),
  
  border_color = "white"
)

draw(hm_split, heatmap_legend_side = "right", padding = unit(c(5, 15, 5, 20), "mm"))

dev.off()
```