---
title: "get_closest_single_ref"
output: html_document
date: "2024-04-18"
---
# edited 1/20/2026 by Eliza 

# Read in packages, functions, and directories
```{r}
source(paste0(here::here(), "/1-Config/config.R"))
```
# Read in info on closest references to capsule and NCBI hits
```{r}
closestRefInfo_allScoreThresholdHits <- read_csv(paste0(treeInfoDir, "closestRefInfo_allScoreThresholdHits.csv"))

closestRefInfo_allScoreThresholdHits_capsule <- read_csv(paste0(treeInfoDir, "closestRefInfo_allScoreThresholdHits_capsule.csv"))


# this was made with all the same rules, but just inserting the MSA from the end of cleanHitsCapsule.smk and not adding the 2018 sequences. I will be using it to see what the Ley3 hits correspond to in the 2015 tree.
closestRefInfo_allScoreThresholdHits_capsule_no_2018 <- read_csv(paste0(treeInfoDir, "closestRefInfo_allScoreThresholdHits_no_2018_capsule.csv"))
```

# For hit sequences with multiple "closest ref sequences", select a single reference sequence as the representative. Choose the first of Mueller2015's sequences in the list. If none of Mueller2015's sequences are in the closest ref list, choose the first of Anantharaman2018's sequences.
```{r}
get_single_ref <- function(ref_list) {
  ref_list <- gsub("\\]", "", ref_list)
  ref_list <- gsub("\\[", "", ref_list)
  ref_list <- gsub(" ", "", ref_list)
  ref_list <- gsub("'", "", ref_list)
  ref_list <- strsplit(ref_list, ",")[[1]]
  
  # check if all of the closest ref sequences are Anantharaman2018 seqs
  if (length(grep("QUERY", ref_list)) == length(ref_list)) {
    # single ref is assigned as first seq in list
    return(ref_list[1])
  }
  
  # case if there is a non-Anantharaman2018 seq in the list of closest_ref
  if (length(grep("QUERY", ref_list)) != length(ref_list)) {
    single_ref_index <- grep("QUERY", ref_list, invert = T)[[1]]
    return(ref_list[single_ref_index])
  }
}

```

```{r}
#check that we are getting output we expect
get_single_ref("['QUERY___Bilophila_wadsworthia_dsrA', 'QUERY___Bilophila_wadsworthia_dsrB', 'Bilophila_sp._4_1_30__BilSpec3', 'Bilophila_wadsworthia__BilWads6']")
```

# add single_closest_refs for the NCBI and CapScan dataframes
```{r}
# NCBI
closestRefInfo_allScoreThresholdHits_wSingleClosestRef <- closestRefInfo_allScoreThresholdHits %>%
  mutate(single_closest_ref = sapply(closest_ref, get_single_ref))

# save as csv
write.csv(closestRefInfo_allScoreThresholdHits_wSingleClosestRef,
          paste0(dataDir,"closestRefInfo_allScoreThresholdHits_wSingleClosestRef.csv"),
          row.names = FALSE)

# CapScan
closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule <- closestRefInfo_allScoreThresholdHits_capsule %>%
  mutate(single_closest_ref = sapply(closest_ref, get_single_ref))

# save as csv
write.csv(closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule,
          paste0(dataDir,"closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule.csv"),
          row.names = FALSE)

#CapScan no 2018 refs
closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule_no_2018 <- closestRefInfo_allScoreThresholdHits_capsule_no_2018 %>%
  mutate(single_closest_ref = sapply(closest_ref, get_single_ref))

# save as csv
write.csv(closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule_no_2018,
          paste0(dataDir,"closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule_no_2018.csv"),
          row.names = FALSE)
```

## what are the Ley3 hits?
```{r}
ley3 <- closestRefInfo_allScoreThresholdHits_wSingleClosestRef_capsule %>% filter(single_closest_ref %in% c("QUERY___Ley3_66761_scaffold_1025_dsrA", "QUERY___Ley3_66761_scaffold_1830_dsrB"))
#look here to see what they hit in 2015
ley3_2015_identity <- closestRefInfo_allScoreThresholdHits_capsule_no_2018 %>% filter(query_id %in% ley3$query_id)
```





